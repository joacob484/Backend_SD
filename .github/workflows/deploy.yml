name: Deploy to Google Cloud Run
permissions:
  contents: read
  issues: write
  id-token: write  # Required for Workload Identity Federation
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: master-might-274420
      GCP_REGION: us-central1
      AR_REPO: faltauno
      CLOUD_RUN_SERVICE: faltauno-backend
      CLOUDSQL_INSTANCE: master-might-274420:us-central1:faltauno-db
      RUNTIME_SA: 169771742214-compute@developer.gserviceaccount.com
      FRONTEND_URL: https://faltauno-frontend-169771742214.us-central1.run.app
      SPRING_DATASOURCE_USERNAME: app
      SPRING_DATASOURCE_DATABASE: faltauno_db
      SPRING_DATASOURCE_NAME: faltauno_db
      SPRING_DATASOURCE_URL: jdbc:postgresql:///faltauno_db?cloudSqlInstance=master-might-274420:us-central1:faltauno-db&socketFactory=com.google.cloud.sql.postgres.SocketFactory
      POSTGRES_HOST: postgres
      IMAGE: "us-central1-docker.pkg.dev/master-might-274420/faltauno/faltauno-backend:${{ github.sha }}"
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Authenticate with Google Cloud (Workload Identity)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/169771742214/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
        service_account: 'deploy-cicd@master-might-274420.iam.gserviceaccount.com'
        audience: 'https://github.com/joacob484/Backend_SD'
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v3
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
    - name: Authenticate Docker with Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
    - name: Build and Deploy to Cloud Run
      run: |
        # Build Docker image
        docker build \
          --platform linux/amd64 \
          --tag ${{ env.IMAGE }} \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          --quiet \
          .
        
        # Push to Artifact Registry
        docker push ${{ env.IMAGE }} --quiet
        
        echo "✓ Image built and pushed: ${{ env.IMAGE }}"
        
        # Deploy new revision and automatically route 100% traffic to it
        gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
          --image=${{ env.IMAGE }} \
          --region=${{ env.GCP_REGION }} \
          --platform=managed \
          --allow-unauthenticated \
          --memory=1Gi \
          --cpu=2 \
          --timeout=300 \
          --min-instances=0 \
          --max-instances=3 \
          --cpu-throttling \
          --concurrency=80 \
          --update-env-vars=SPRING_PROFILES_ACTIVE=cloudrun,GOOGLE_CLOUD_PROJECT=${{ env.GCP_PROJECT_ID }},CLOUD_SQL_INSTANCE=${{ env.CLOUDSQL_INSTANCE }},GOOGLE_VISION_CREDENTIALS_PATH=/secrets/google-credentials.json \
          --remove-env-vars=SMS_ENABLED,SMS_PROVIDER,PHONE_VERIFICATION_ENABLED,GOOGLE_APPLICATION_CREDENTIALS \
          --add-cloudsql-instances=${{ env.CLOUDSQL_INSTANCE }} \
          --update-secrets=SPRING_DATASOURCE_PASSWORD=db-password:latest,JWT_SECRET=jwt-secret:latest,GOOGLE_CLIENT_ID=google-client-id:latest,GOOGLE_CLIENT_SECRET=google-client-secret:latest,MAIL_USERNAME=mail-username:latest,MAIL_PASSWORD=mail-password:latest,/secrets/google-credentials.json=google-vision-credentials:latest \
          --remove-secrets=TERMII_API_KEY,TERMII_SENDER_ID,GOOGLE_APPLICATION_CREDENTIALS \
          --clear-vpc-connector \
          --port=8080 \
          --quiet
        
        SERVICE_URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
          --region=${{ env.GCP_REGION }} \
          --format='value(status.url)')
        
        echo "✓ Deployed successfully"
        echo "✓ Service: $SERVICE_URL"
    - name: Notify on Failure (create issue)
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          // Create an issue in the repo with the failure details so you can track it
          const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
          github.rest.issues.create({
            owner: owner,
            repo: repo,
            title: `Deployment failed: ${process.env.GITHUB_SHA}`,
            body: `Deployment failed for commit ${process.env.GITHUB_SHA}. Check the Actions logs: ${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`
          });
