name: Deploy to Google Cloud Run
permissions:
  contents: read
  issues: write
  id-token: write  # Required for Workload Identity Federation
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: master-might-274420
      GCP_REGION: us-central1
      AR_REPO: faltauno
      CLOUD_RUN_SERVICE: faltauno-backend
      CLOUDSQL_INSTANCE: master-might-274420:us-central1:faltauno-db
      RUNTIME_SA: 169771742214-compute@developer.gserviceaccount.com
      FRONTEND_URL: https://faltauno-frontend-169771742214.us-central1.run.app
      SPRING_DATASOURCE_USERNAME: app
      SPRING_DATASOURCE_DATABASE: faltauno_db
      SPRING_DATASOURCE_NAME: faltauno_db
      SPRING_DATASOURCE_URL: jdbc:postgresql:///faltauno_db?cloudSqlInstance=master-might-274420:us-central1:faltauno-db&socketFactory=com.google.cloud.sql.postgres.SocketFactory
      POSTGRES_HOST: postgres
      # Pub/Sub configuration - set to false to disable Pub/Sub features
      GCP_PUBSUB_ENABLED: "true"
      GCP_PUBSUB_TOPIC: faltauno-events
      GCP_PUBSUB_SUBSCRIPTION: faltauno-events-sub
      IMAGE: "us-central1-docker.pkg.dev/master-might-274420/faltauno/faltauno-backend:${{ github.sha }}"
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Authenticate with Google Cloud (Workload Identity)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/169771742214/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
        service_account: 'deploy-cicd@master-might-274420.iam.gserviceaccount.com'
        audience: 'https://github.com/joacob484/Backend_SD'
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v3
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
    - name: Authenticate Docker with Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
    - name: Build and Deploy to Cloud Run
      run: |
        echo "========================================"
        echo " BUILDING DOCKER IMAGE"
        echo "========================================"
        echo ""
        
        # Build Docker image
        docker build \
          --platform linux/amd64 \
          --tag ${{ env.IMAGE }} \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          .
        
        echo ""
        echo "Image built: ${{ env.IMAGE }}"
        echo ""
        
        echo "========================================"
        echo " PUSHING TO ARTIFACT REGISTRY"
        echo "========================================"
        echo ""
        
        # Push to Artifact Registry
        docker push ${{ env.IMAGE }}
        
        echo ""
        echo "Image pushed successfully"
        echo ""
        
        echo "========================================"
        echo " DEPLOYING TO CLOUD RUN"
        echo "========================================"
        echo ""
        echo "Build with Dockerfile"
        echo "Zero-downtime deployment"
        echo "Automatic traffic migration"
        echo ""
        
        # Deploy new revision without traffic first (for validation)
        gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
          --image=${{ env.IMAGE }} \
          --region=${{ env.GCP_REGION }} \
          --platform=managed \
          --allow-unauthenticated \
          --memory=2Gi \
          --cpu=2 \
          --timeout=600 \
          --min-instances=0 \
          --max-instances=10 \
          --cpu-boost \
          --cpu-throttling \
          --update-env-vars=SPRING_PROFILES_ACTIVE=cloudrun \
          --update-env-vars=GOOGLE_CLOUD_PROJECT=${{ env.GCP_PROJECT_ID }} \
          --update-env-vars=CLOUD_SQL_INSTANCE=${{ env.CLOUDSQL_INSTANCE }} \
          --add-cloudsql-instances=${{ env.CLOUDSQL_INSTANCE }} \
          --update-secrets=SPRING_DATASOURCE_PASSWORD=termii-sender-id:latest \
          --update-secrets=/secrets/google-credentials.json=google-vision-credentials:latest \
          --clear-vpc-connector \
          --no-traffic \
          --tag=candidate \
          --quiet
        
        # Get new revision name
        NEW_REVISION=$(gcloud run revisions list \
          --service=${{ env.CLOUD_RUN_SERVICE }} \
          --region=${{ env.GCP_REGION }} \
          --format='value(metadata.name)' \
          --sort-by='~metadata.creationTimestamp' \
          --limit=1)
        
        echo "New revision: $NEW_REVISION"
        
        # Migrate 100% traffic to new revision
        echo "Migrating 100% traffic to $NEW_REVISION..."
        gcloud run services update-traffic ${{ env.CLOUD_RUN_SERVICE }} \
          --region=${{ env.GCP_REGION }} \
          --to-revisions=$NEW_REVISION=100 \
          --quiet
        
        echo ""
        echo "Deployment complete!"
        echo "Traffic migrated to new revision: $NEW_REVISION"
        echo "Service URL:"
        gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
          --region=${{ env.GCP_REGION }} \
          --format='value(status.url)'
    - name: Detect Service Changes
      id: detect-changes
      run: |
        echo "Detecting service changes..."
        
        # Detect changes in Pub/Sub related files
        PUBSUB_CHANGED=false
        if git diff --name-only HEAD~1 HEAD | grep -iE "(pubsub|PubSub|EventPublisher|EventSubscriber)" > /dev/null 2>&1; then
          PUBSUB_CHANGED=true
          echo "Changes detected in Pub/Sub code"
        fi
        
        echo "pubsub_changed=$PUBSUB_CHANGED" >> $GITHUB_OUTPUT
        
        echo ""
        echo "Summary of changes:"
        echo "  Pub/Sub: $PUBSUB_CHANGED"
    - name: Verify Pub/Sub Setup
      if: steps.detect-changes.outputs.pubsub_changed == 'true' || env.GCP_PUBSUB_ENABLED == 'true'
      run: |
        echo "Verifying Pub/Sub configuration..."
        echo ""
        
        # Create topic if it doesn't exist
        if ! gcloud pubsub topics describe ${{ env.GCP_PUBSUB_TOPIC }} --project=${{ env.GCP_PROJECT_ID }} > /dev/null 2>&1; then
          echo "Creating topic: ${{ env.GCP_PUBSUB_TOPIC }}"
          gcloud pubsub topics create ${{ env.GCP_PUBSUB_TOPIC }} --project=${{ env.GCP_PROJECT_ID }}
        else
          echo "Topic exists: ${{ env.GCP_PUBSUB_TOPIC }}"
        fi
        
        # Create subscription if it doesn't exist
        if ! gcloud pubsub subscriptions describe ${{ env.GCP_PUBSUB_SUBSCRIPTION }} --project=${{ env.GCP_PROJECT_ID }} > /dev/null 2>&1; then
          echo "Creating subscription: ${{ env.GCP_PUBSUB_SUBSCRIPTION }}"
          gcloud pubsub subscriptions create ${{ env.GCP_PUBSUB_SUBSCRIPTION }} \
            --topic=${{ env.GCP_PUBSUB_TOPIC }} \
            --ack-deadline=60 \
            --message-retention-duration=7d \
            --project=${{ env.GCP_PROJECT_ID }}
        else
          echo "Subscription exists: ${{ env.GCP_PUBSUB_SUBSCRIPTION }}"
        fi
        
        echo ""
        echo "Pub/Sub configured correctly"
    - name: Notify on Failure (create issue)
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          // Create an issue in the repo with the failure details so you can track it
          const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
          github.rest.issues.create({
            owner: owner,
            repo: repo,
            title: `Deployment failed: ${process.env.GITHUB_SHA}`,
            body: `Deployment failed for commit ${process.env.GITHUB_SHA}. Check the Actions logs: ${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`
          });
