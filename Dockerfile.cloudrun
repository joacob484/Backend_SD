# ═══════════════════════════════════════════════════════════
# DOCKERFILE PARA CLOUD RUN - BUILD COMPLETO SIN CACHE
# ═══════════════════════════════════════════════════════════

# Build stage - USAR IMAGEN STANDARD (no Alpine) para mejor compatibilidad
FROM maven:3.9-eclipse-temurin-21 AS builder

WORKDIR /build

# Copy project files
COPY pom.xml .
COPY src ./src

# Build with MAXIMUM VERBOSE output
RUN echo "════════════════════════════════════════════════════════" && \
    echo "🔨 STARTING MAVEN BUILD" && \
    echo "════════════════════════════════════════════════════════" && \
    mvn --version && \
    echo "" && \
    echo "📦 Running: mvn clean package -DskipTests" && \
    echo "" && \
    mvn clean package -DskipTests -B -X && \
    echo "" && \
    echo "════════════════════════════════════════════════════════" && \
    echo "✅ BUILD COMPLETE - Checking target/" && \
    echo "════════════════════════════════════════════════════════" && \
    ls -lah target/ && \
    echo "" && \
    echo "JAR files found:" && \
    find target/ -name "*.jar" -type f && \
    echo "════════════════════════════════════════════════════════"

# ═══════════════════════════════════════════════════════════
# Runtime stage
# ═══════════════════════════════════════════════════════════
FROM eclipse-temurin:21-jre

WORKDIR /app

# Copy JAR with explicit naming
COPY --from=builder /build/target/*.jar app.jar

# Verify JAR exists and show contents
RUN echo "════════════════════════════════════════════════════════" && \
    echo "🔍 VERIFYING JAR FILE" && \
    echo "════════════════════════════════════════════════════════" && \
    ls -lah /app/app.jar && \
    echo "" && \
    echo "JAR manifest:" && \
    jar tf /app/app.jar | head -30 && \
    echo "" && \
    echo "JAR size: $(stat -f%z /app/app.jar 2>/dev/null || stat -c%s /app/app.jar) bytes" && \
    echo "════════════════════════════════════════════════════════"

# Expose port
EXPOSE 8080

# Run with environment-based PORT
CMD ["sh", "-c", "java -Xmx1024m -Xms512m -Dserver.port=${PORT:-8080} -jar /app/app.jar"]
