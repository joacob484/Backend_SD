steps:
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # STEP 1: BUILD DOCKER IMAGE - SIN CACHE
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args: 
      - 'build'
      - '--no-cache'
      - '--progress=plain'
      - '-t'
      - 'gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID'
      - '-t'
      - 'gcr.io/$PROJECT_ID/faltauno-backend:latest'
      - '-f'
      - 'Dockerfile.cloudrun'
      - '.'
    timeout: '1200s'  # 20 minutes para build completo

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # STEP 2: VERIFICAR QUE EL JAR EXISTE EN LA IMAGEN
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'verify-jar'
    args:
      - 'run'
      - '--rm'
      - '--entrypoint=sh'
      - 'gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID'
      - '-c'
      - 'ls -lah /app/app.jar && echo "JAR size:" && du -h /app/app.jar && echo "First 20 classes in JAR:" && jar tf /app/app.jar | grep "\.class$" | head -20'
    waitFor: ['build-image']

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # STEP 3: PUSH IMAGE TO REGISTRY
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args: 
      - 'push'
      - '--all-tags'
      - 'gcr.io/$PROJECT_ID/faltauno-backend'
    waitFor: ['verify-jar']

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # STEP 4: DEPLOY TO CLOUD RUN WITH ZERO DOWNTIME
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-cloudrun'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        
        echo "=========================================="
        echo "๐ DEPLOYING TO CLOUD RUN"
        echo "=========================================="
        echo ""
        echo "Build ID: $BUILD_ID"
        echo "Image: gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID"
        echo ""
        
        # Check if service exists
        if gcloud run services describe faltauno-backend \
          --region=us-central1 \
          --project=$PROJECT_ID \
          --format='value(metadata.name)' 2>/dev/null; then
          
          echo "โ Service exists - deploying new revision with --no-traffic"
          echo ""
          
          # Deploy new revision WITHOUT traffic (zero downtime)
          NEW_REVISION=$$(gcloud run deploy faltauno-backend \
            --image=gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID \
            --region=us-central1 \
            --platform=managed \
            --no-traffic \
            --timeout=600 \
            --memory=2Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --add-cloudsql-instances="${_CLOUDSQL_INSTANCE}" \
            --set-env-vars="SERVER_PORT=8080" \
            --set-env-vars="SPRING_DATASOURCE_URL=${_SPRING_DATASOURCE_URL}" \
            --set-env-vars="SPRING_DATASOURCE_USERNAME=${_SPRING_DATASOURCE_USERNAME}" \
            --set-env-vars="SPRING_DATASOURCE_DATABASE=${_SPRING_DATASOURCE_DATABASE}" \
            --set-env-vars="SPRING_DATASOURCE_NAME=${_SPRING_DATASOURCE_NAME}" \
            --set-env-vars="SPRING_CLOUDSQL_INSTANCE=${_CLOUDSQL_INSTANCE}" \
            --set-env-vars="SPRING_REDIS_HOST=${_REDIS_HOST}" \
            --set-env-vars="REDIS_HOST=${_REDIS_HOST}" \
            --set-env-vars="POSTGRES_HOST=${_POSTGRES_HOST}" \
            --set-env-vars="GCP_PUBSUB_ENABLED=${_GCP_PUBSUB_ENABLED}" \
            --set-env-vars="GCP_PUBSUB_TOPIC=${_GCP_PUBSUB_TOPIC}" \
            --set-env-vars="GCP_PUBSUB_SUBSCRIPTION=${_GCP_PUBSUB_SUBSCRIPTION}" \
            --set-env-vars="GCP_PROJECT_ID=$PROJECT_ID" \
            --set-env-vars="FRONTEND_URL=${_FRONTEND_URL}" \
            --update-secrets="SPRING_DATASOURCE_PASSWORD=db-password:latest" \
            --update-secrets="JWT_SECRET=jwt-secret:latest" \
            --update-secrets="GOOGLE_CLIENT_ID=google-client-id:latest" \
            --update-secrets="GOOGLE_CLIENT_SECRET=google-client-secret:latest" \
            --service-account=169771742214-compute@developer.gserviceaccount.com \
            --allow-unauthenticated \
            --format='value(status.latestCreatedRevisionName)')
          
          echo ""
          echo "โ New revision created: $$NEW_REVISION"
          echo ""
          echo "โณ Waiting for revision to be ready..."
          
          # Wait for revision to be ready (max 5 minutes)
          for i in {1..60}; do
            READY=$$(gcloud run revisions describe "$$NEW_REVISION" \
              --region=us-central1 \
              --platform=managed \
              --format='value(status.conditions[?(@.type=="Ready")].status)' 2>/dev/null || echo "Unknown")
            
            echo "[$$i/60] Revision status: $$READY"
            
            if [ "$$READY" = "True" ]; then
              echo ""
              echo "โ Revision is READY!"
              break
            fi
            
            if [ "$$i" -eq 60 ]; then
              echo ""
              echo "โ Revision did not become ready after 5 minutes"
              gcloud run revisions describe "$$NEW_REVISION" --region=us-central1 --platform=managed
              exit 1
            fi
            
            sleep 5
          done
          
          echo ""
          echo "๐ Routing 100% traffic to new revision (zero downtime cutover)..."
          
          gcloud run services update-traffic faltauno-backend \
            --to-revisions="$$NEW_REVISION=100" \
            --region=us-central1 \
            --platform=managed
          
          echo ""
          echo "โ Traffic routed successfully!"
          echo ""
          
        else
          echo "โ๏ธ  Service doesn't exist - creating new service"
          echo ""
          
          # Initial deployment (will receive traffic immediately)
          gcloud run deploy faltauno-backend \
            --image=gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID \
            --region=us-central1 \
            --platform=managed \
            --timeout=600 \
            --memory=2Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --add-cloudsql-instances="${_CLOUDSQL_INSTANCE}" \
            --set-env-vars="SERVER_PORT=8080" \
            --set-env-vars="SPRING_DATASOURCE_URL=${_SPRING_DATASOURCE_URL}" \
            --set-env-vars="SPRING_DATASOURCE_USERNAME=${_SPRING_DATASOURCE_USERNAME}" \
            --set-env-vars="SPRING_DATASOURCE_DATABASE=${_SPRING_DATASOURCE_DATABASE}" \
            --set-env-vars="SPRING_DATASOURCE_NAME=${_SPRING_DATASOURCE_NAME}" \
            --set-env-vars="SPRING_CLOUDSQL_INSTANCE=${_CLOUDSQL_INSTANCE}" \
            --set-env-vars="SPRING_REDIS_HOST=${_REDIS_HOST}" \
            --set-env-vars="REDIS_HOST=${_REDIS_HOST}" \
            --set-env-vars="POSTGRES_HOST=${_POSTGRES_HOST}" \
            --set-env-vars="GCP_PUBSUB_ENABLED=${_GCP_PUBSUB_ENABLED}" \
            --set-env-vars="GCP_PUBSUB_TOPIC=${_GCP_PUBSUB_TOPIC}" \
            --set-env-vars="GCP_PUBSUB_SUBSCRIPTION=${_GCP_PUBSUB_SUBSCRIPTION}" \
            --set-env-vars="GCP_PROJECT_ID=$PROJECT_ID" \
            --set-env-vars="FRONTEND_URL=${_FRONTEND_URL}" \
            --update-secrets="SPRING_DATASOURCE_PASSWORD=db-password:latest" \
            --update-secrets="JWT_SECRET=jwt-secret:latest" \
            --update-secrets="GOOGLE_CLIENT_ID=google-client-id:latest" \
            --update-secrets="GOOGLE_CLIENT_SECRET=google-client-secret:latest" \
            --service-account=169771742214-compute@developer.gserviceaccount.com \
            --allow-unauthenticated
          
          echo ""
          echo "โ Service created successfully!"
        fi
        
        echo ""
        echo "=========================================="
        echo "โ DEPLOYMENT COMPLETED SUCCESSFULLY"
        echo "=========================================="
        echo ""
        
        # Get service URL
        SERVICE_URL=$$(gcloud run services describe faltauno-backend \
          --region=us-central1 \
          --platform=managed \
          --format='value(status.url)')
        
        echo "๐ Service URL: $$SERVICE_URL"
        echo "๐ฅ Health Check: $$SERVICE_URL/actuator/health"
        echo ""
    waitFor: ['push-image']
    timeout: '900s'

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TIMEOUT GLOBAL Y OPCIONES
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
timeout: '2400s'  # 40 minutes total

options:
  machineType: 'E2_HIGHCPU_8'  # 8 vCPUs para build mรกs rรกpido
  logging: CLOUD_LOGGING_ONLY
  logStreamingOption: STREAM_ON

images:
  - 'gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID'

substitutions:
  _REDIS_HOST: "10.128.0.2"
  _POSTGRES_HOST: "postgres"
  _CLOUDSQL_INSTANCE: "master-might-274420:us-central1:faltauno-db"
  _SPRING_DATASOURCE_USERNAME: "app"
  _SPRING_DATASOURCE_DATABASE: "faltauno_db"
  _SPRING_DATASOURCE_NAME: "faltauno_db"
  _SPRING_DATASOURCE_URL: "jdbc:postgresql:///faltauno_db?cloudSqlInstance=master-might-274420:us-central1:faltauno-db&socketFactory=com.google.cloud.sql.postgres.SocketFactory"
  _GCP_PUBSUB_ENABLED: "false"
  _GCP_PUBSUB_TOPIC: "faltauno-events"
  _GCP_PUBSUB_SUBSCRIPTION: "faltauno-events-sub"
  _FRONTEND_URL: "https://faltauno-frontend-169771742214.us-central1.run.app"
