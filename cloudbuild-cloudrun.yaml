steps:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: BUILD DOCKER IMAGE - SIN CACHE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args: 
      - 'build'
      - '--no-cache'
      - '--progress=plain'
      - '-t'
      - 'gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID'
      - '-t'
      - 'gcr.io/$PROJECT_ID/faltauno-backend:latest'
      - '-f'
      - 'Dockerfile.cloudrun'
      - '.'
    timeout: '1200s'  # 20 minutes para build completo

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: VERIFICAR QUE EL JAR EXISTE EN LA IMAGEN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'gcr.io/cloud-builders/docker'
    id: 'verify-jar'
    args:
      - 'run'
      - '--rm'
      - '--entrypoint=sh'
      - 'gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID'
      - '-c'
      - 'ls -lah /app/app.jar && echo "JAR size:" && du -h /app/app.jar && echo "First 20 classes in JAR:" && jar tf /app/app.jar | grep "\.class$" | head -20'
    waitFor: ['build-image']

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: PUSH IMAGE TO REGISTRY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args: 
      - 'push'
      - '--all-tags'
      - 'gcr.io/$PROJECT_ID/faltauno-backend'
    waitFor: ['verify-jar']

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: DEPLOY TO CLOUD RUN WITH ZERO DOWNTIME
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-cloudrun'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        
        echo "=========================================="
        echo "ğŸš€ DEPLOYING TO CLOUD RUN"
        echo "=========================================="
        echo ""
        echo "Build ID: $BUILD_ID"
        echo "Image: gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID"
        echo ""
        
        # Check if service exists
        if gcloud run services describe faltauno-backend \
          --region=us-central1 \
          --project=$PROJECT_ID \
          --format='value(metadata.name)' 2>/dev/null; then
          
          echo "âœ… Service exists - deploying new revision with --no-traffic"
          echo ""
          
          # Deploy new revision WITHOUT traffic (zero downtime)
          NEW_REVISION=$$(gcloud run deploy faltauno-backend \
            --image=gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID \
            --region=us-central1 \
            --platform=managed \
            --no-traffic \
            --timeout=600 \
            --memory=2Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --add-cloudsql-instances="${_CLOUDSQL_INSTANCE}" \
            --vpc-connector=run-connector \
            --vpc-egress=private-ranges-only \
            --set-env-vars="SERVER_PORT=8080" \
            --set-env-vars="SPRING_DATASOURCE_URL=${_SPRING_DATASOURCE_URL}" \
            --set-env-vars="SPRING_DATASOURCE_USERNAME=${_SPRING_DATASOURCE_USERNAME}" \
            --set-env-vars="SPRING_DATASOURCE_DATABASE=${_SPRING_DATASOURCE_DATABASE}" \
            --set-env-vars="SPRING_DATASOURCE_NAME=${_SPRING_DATASOURCE_NAME}" \
            --set-env-vars="SPRING_CLOUDSQL_INSTANCE=${_CLOUDSQL_INSTANCE}" \
            --set-env-vars="SPRING_REDIS_HOST=${_REDIS_HOST}" \
            --set-env-vars="SPRING_REDIS_PORT=${_REDIS_PORT}" \
            --set-env-vars="REDIS_HOST=${_REDIS_HOST}" \
            --set-env-vars="POSTGRES_HOST=${_POSTGRES_HOST}" \
            --set-env-vars="GCP_PUBSUB_ENABLED=${_GCP_PUBSUB_ENABLED}" \
            --set-env-vars="GCP_PUBSUB_TOPIC=${_GCP_PUBSUB_TOPIC}" \
            --set-env-vars="GCP_PUBSUB_SUBSCRIPTION=${_GCP_PUBSUB_SUBSCRIPTION}" \
            --set-env-vars="GCP_PROJECT_ID=$PROJECT_ID" \
            --set-env-vars="FRONTEND_URL=${_FRONTEND_URL}" \
            --update-secrets="SPRING_DATASOURCE_PASSWORD=db-password:latest" \
            --update-secrets="JWT_SECRET=jwt-secret:latest" \
            --update-secrets="GOOGLE_CLIENT_ID=google-client-id:latest" \
            --update-secrets="GOOGLE_CLIENT_SECRET=google-client-secret:latest" \
            --update-secrets="MAIL_USERNAME=mail-username:latest" \
            --update-secrets="MAIL_PASSWORD=mail-password:latest" \
            --service-account=169771742214-compute@developer.gserviceaccount.com \
            --allow-unauthenticated \
            --format='value(status.latestCreatedRevisionName)')
          
          echo ""
          echo "âœ… New revision created: $$NEW_REVISION"
          echo ""
          echo "â³ Waiting for revision to be ready (checking every 5 seconds)..."
          
          # Wait for revision to be ready
          TIMEOUT=300  # 5 minutes max
          ELAPSED=0
          READY="Unknown"
          
          while [ $$ELAPSED -lt $$TIMEOUT ]; do
            # Get the JSON and extract Ready status with python (available in gcloud image)
            READY=$$(gcloud run revisions describe "$$NEW_REVISION" \
              --region=us-central1 \
              --platform=managed \
              --format=json 2>/dev/null | \
              python3 -c "import sys, json; data=json.load(sys.stdin); conditions=[c for c in data.get('status',{}).get('conditions',[]) if c.get('type')=='Ready']; print(conditions[0].get('status','Unknown') if conditions else 'Unknown')" 2>/dev/null || echo "Unknown")
            
            if [ "$$READY" = "True" ]; then
              echo ""
              echo "âœ… Revision is READY after $$ELAPSED seconds!"
              break
            fi
            
            # Show progress every 30 seconds only
            if [ $$((ELAPSED % 30)) -eq 0 ]; then
              echo "[$$ELAPSED s] Revision status: $$READY (checking...)"
            fi
            
            sleep 5
            ELAPSED=$$((ELAPSED + 5))
          done
          
          # Check if we timed out
          if [ "$$READY" != "True" ]; then
            echo ""
            echo "âŒ Revision did not become ready after $$ELAPSED seconds"
            echo "Last known status: $$READY"
            gcloud run revisions describe "$$NEW_REVISION" --region=us-central1 --platform=managed
            exit 1
          fi
          
          echo ""
          echo "ğŸ”„ Routing 100% traffic to new revision (zero downtime cutover)..."
          
          gcloud run services update-traffic faltauno-backend \
            --to-revisions="$$NEW_REVISION=100" \
            --region=us-central1 \
            --platform=managed
          
          echo ""
          echo "âœ… Traffic routed successfully!"
          echo ""
          
        else
          echo "âš ï¸  Service doesn't exist - creating new service"
          echo ""
          
          # Initial deployment (will receive traffic immediately)
          gcloud run deploy faltauno-backend \
            --image=gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID \
            --region=us-central1 \
            --platform=managed \
            --timeout=600 \
            --memory=2Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --add-cloudsql-instances="${_CLOUDSQL_INSTANCE}" \
            --vpc-connector=run-connector \
            --vpc-egress=private-ranges-only \
            --set-env-vars="SERVER_PORT=8080" \
            --set-env-vars="SPRING_DATASOURCE_URL=${_SPRING_DATASOURCE_URL}" \
            --set-env-vars="SPRING_DATASOURCE_USERNAME=${_SPRING_DATASOURCE_USERNAME}" \
            --set-env-vars="SPRING_DATASOURCE_DATABASE=${_SPRING_DATASOURCE_DATABASE}" \
            --set-env-vars="SPRING_DATASOURCE_NAME=${_SPRING_DATASOURCE_NAME}" \
            --set-env-vars="SPRING_CLOUDSQL_INSTANCE=${_CLOUDSQL_INSTANCE}" \
            --set-env-vars="SPRING_REDIS_HOST=${_REDIS_HOST}" \
            --set-env-vars="SPRING_REDIS_PORT=${_REDIS_PORT}" \
            --set-env-vars="REDIS_HOST=${_REDIS_HOST}" \
            --set-env-vars="POSTGRES_HOST=${_POSTGRES_HOST}" \
            --set-env-vars="GCP_PUBSUB_ENABLED=${_GCP_PUBSUB_ENABLED}" \
            --set-env-vars="GCP_PUBSUB_TOPIC=${_GCP_PUBSUB_TOPIC}" \
            --set-env-vars="GCP_PUBSUB_SUBSCRIPTION=${_GCP_PUBSUB_SUBSCRIPTION}" \
            --set-env-vars="GCP_PROJECT_ID=$PROJECT_ID" \
            --set-env-vars="FRONTEND_URL=${_FRONTEND_URL}" \
            --update-secrets="SPRING_DATASOURCE_PASSWORD=db-password:latest" \
            --update-secrets="JWT_SECRET=jwt-secret:latest" \
            --update-secrets="GOOGLE_CLIENT_ID=google-client-id:latest" \
            --update-secrets="GOOGLE_CLIENT_SECRET=google-client-secret:latest" \
            --update-secrets="MAIL_USERNAME=mail-username:latest" \
            --update-secrets="MAIL_PASSWORD=mail-password:latest" \
            --service-account=169771742214-compute@developer.gserviceaccount.com \
            --allow-unauthenticated
          
          echo ""
          echo "âœ… Service created successfully!"
        fi
        
        echo ""
        echo "=========================================="
        echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY"
        echo "=========================================="
        echo ""
        
        # Get service URL
        SERVICE_URL=$$(gcloud run services describe faltauno-backend \
          --region=us-central1 \
          --platform=managed \
          --format='value(status.url)')
        
        echo "ğŸŒ Service URL: $$SERVICE_URL"
        echo "ğŸ¥ Health Check: $$SERVICE_URL/actuator/health"
        echo ""
    waitFor: ['push-image']
    timeout: '900s'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TIMEOUT GLOBAL Y OPCIONES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
timeout: '2400s'  # 40 minutes total

options:
  machineType: 'E2_HIGHCPU_8'  # 8 vCPUs para build mÃ¡s rÃ¡pido
  logging: CLOUD_LOGGING_ONLY
  logStreamingOption: STREAM_ON

images:
  - 'gcr.io/$PROJECT_ID/faltauno-backend:$BUILD_ID'

substitutions:
  _REDIS_HOST: "10.217.135.172"  # faltauno-redis instance IP
  _REDIS_PORT: "6379"
  _POSTGRES_HOST: "postgres"
  _CLOUDSQL_INSTANCE: "master-might-274420:us-central1:faltauno-db"
  _SPRING_DATASOURCE_USERNAME: "app"
  _SPRING_DATASOURCE_DATABASE: "faltauno_db"
  _SPRING_DATASOURCE_NAME: "faltauno_db"
  _SPRING_DATASOURCE_URL: "jdbc:postgresql:///faltauno_db?cloudSqlInstance=master-might-274420:us-central1:faltauno-db&socketFactory=com.google.cloud.sql.postgres.SocketFactory"
  _GCP_PUBSUB_ENABLED: "true"
  _GCP_PUBSUB_TOPIC: "faltauno-events"
  _GCP_PUBSUB_SUBSCRIPTION: "faltauno-events-sub"
  _FRONTEND_URL: "https://faltauno-frontend-169771742214.us-central1.run.app"
