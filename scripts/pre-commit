#!/bin/bash
#
# Git pre-commit hook para validar configuraci√≥n de Redis
# Instalar: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

# Solo validar si cloudbuild-cloudrun.yaml fue modificado
if git diff --cached --name-only | grep -q "cloudbuild-cloudrun.yaml"; then
    echo "üîç Detectado cambio en cloudbuild-cloudrun.yaml, validando Redis..."
    
    EXPECTED_REDIS_IP="10.217.135.172"
    EXPECTED_REDIS_PORT="6379"
    
    # Verificar IP de Redis en el archivo staged
    if ! git diff --cached cloudbuild-cloudrun.yaml | grep -q "^\+.*_REDIS_HOST: \"$EXPECTED_REDIS_IP\"" && \
       ! git show :cloudbuild-cloudrun.yaml | grep -q "_REDIS_HOST: \"$EXPECTED_REDIS_IP\""; then
        echo "‚ùå ERROR: IP de Redis incorrecta en cloudbuild-cloudrun.yaml"
        echo "   Esperado: _REDIS_HOST: \"$EXPECTED_REDIS_IP\""
        echo "   Por favor corrige antes de commitear."
        echo "   Leer: REDIS_CRITICAL_CONFIG.md"
        exit 1
    fi
    
    # Verificar puerto de Redis
    if ! git diff --cached cloudbuild-cloudrun.yaml | grep -q "^\+.*_REDIS_PORT: \"$EXPECTED_REDIS_PORT\"" && \
       ! git show :cloudbuild-cloudrun.yaml | grep -q "_REDIS_PORT: \"$EXPECTED_REDIS_PORT\""; then
        echo "‚ùå ERROR: Puerto de Redis incorrecto en cloudbuild-cloudrun.yaml"
        echo "   Esperado: _REDIS_PORT: \"$EXPECTED_REDIS_PORT\""
        echo "   Por favor corrige antes de commitear."
        echo "   Leer: REDIS_CRITICAL_CONFIG.md"
        exit 1
    fi
    
    echo "‚úÖ Configuraci√≥n de Redis validada correctamente"
fi

exit 0
